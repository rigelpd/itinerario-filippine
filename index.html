<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerario di Viaggio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .card {
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1.5rem; /* mb-6 */
            transition: all 0.3s ease-in-out;
            border-left-width: 4px;
            background-color: white;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-lg */
            transform: translateY(-2px);
        }
        h1, h2, h3 {
            font-weight: 700;
        }
        input, textarea, select {
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* border-gray-300 */
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
        }
        textarea {
            resize: none;
            overflow: hidden;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 2px #c7d2fe; /* indigo-200 */
        }
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #4b5563; /* gray-600 */
        }
        .day-card { border-color: #a5b4fc; }
        .flight-card { background-color: #e0e7ff; border-color: #818cf8; }
        .image-placeholder { min-height: 220px; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .tab-button:not(.active) {
            background-color: white;
            color: #4f46e5;
            border-color: #e0e7ff;
        }
        #save-status {
            transition: opacity 0.5s ease-in-out;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* Admin mode styles */
        .admin-only, .admin-only-flex, .admin-only-grid { display: none !important; }
        body.admin-mode .admin-only { display: inline-block !important; }
        body.admin-mode .admin-only-flex { display: flex !important; }
        body.admin-mode .admin-only-grid { display: grid !important; }
        body.admin-mode .user-only { display: none !important; }
        
        /* Readonly styles for user mode */
        .readonly-text {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 0.5rem 0.75rem;
            width: 100%;
            white-space: pre-wrap;
            word-break: break-word;
            color: #374151; /* gray-700 */
            min-height: 38px;
            border-radius: 0.5rem;
        }
        .day-card-wrapper, .flight-card {
             page-break-inside: avoid;
        }
        
        /* Calendar styles */
        .calendar-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 50px;
            padding-top: 4px;
        }
        .calendar-day.trip-day {
            background-color: #dcfce7; /* green-100 */
            color: #166534; /* green-800 */
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .calendar-day.trip-day:hover {
            background-color: #bbf7d0; /* green-200 */
            transform: scale(1.05);
        }
        .calendar-day.today .day-number {
            box-shadow: 0 0 0 2px #6366f1; /* indigo-500 */
            border-radius: 9999px;
            background-color: #e0e7ff;
        }
        .day-number {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-icons {
            font-size: 0.75rem;
            line-height: 1;
            margin-top: 2px;
        }

        @media print {
            body { background-color: white; }
            .no-print, .no-print * { display: none !important; }
            .card { box-shadow: none; border: 1px solid #e5e7eb; }
            .day-card-wrapper, .flight-card { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <!-- Site Password Modal -->
    <div id="site-password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 no-print">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold mb-4">Accesso Richiesto</h2>
            <p class="text-gray-600 mb-6">Inserisci la password per visualizzare l'itinerario.</p>
            <form id="site-password-form">
                <input type="password" id="site-password-input" class="w-full px-4 py-2 border rounded-lg text-center focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                <p id="site-password-error" class="text-red-500 text-sm mt-2 hidden">Password errata. Riprova.</p>
                <button type="submit" class="w-full mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Accedi</button>
            </form>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 no-print hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold mb-4">Accesso Amministratore</h2>
            <p class="text-gray-600 mb-6">Inserisci la password per modificare l'itinerario.</p>
            <form id="admin-login-form">
                <input type="password" id="admin-password-input" class="w-full px-4 py-2 border rounded-lg text-center focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                <p id="admin-password-error" class="text-red-500 text-sm mt-2 hidden">Password errata. Riprova.</p>
                <button type="submit" class="w-full mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Login Admin</button>
                <button type="button" id="admin-cancel-btn" class="w-full mt-2 px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Annulla</button>
            </form>
        </div>
    </div>

    <!-- GitHub Image Modal -->
    <div id="github-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-40 items-center justify-center hidden no-print">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-4 flex flex-col" style="height: 90vh;">
            <h2 class="text-2xl font-bold mb-4">Seleziona un'immagine da GitHub</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="github-user" placeholder="Nome utente GitHub" class="flex-grow">
                <input type="text" id="github-repo" placeholder="Nome repository (pubblico)" class="flex-grow">
                <button id="fetch-github-images-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Carica Immagini</button>
            </div>
            <div id="github-feedback" class="text-sm mb-2"></div>
            <div id="github-image-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto p-2 bg-slate-100 rounded-lg flex-grow"></div>
            <button id="close-github-modal-btn" class="mt-4 w-full px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors">Chiudi</button>
        </div>
    </div>
    
    <!-- PDF Quality Modal -->
    <div id="pdf-quality-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden no-print">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold mb-4">Scegli la qualità del PDF</h2>
            <p class="text-gray-600 mb-6">Una qualità più bassa produce un file più piccolo.</p>
            <div class="flex flex-col gap-4">
                <button data-quality="low" class="pdf-quality-btn w-full px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors">
                    Bassa <span class="block text-xs font-normal">(Veloce, file piccolo)</span>
                </button>
                <button data-quality="medium" class="pdf-quality-btn w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                    Media <span class="block text-xs font-normal">(Consigliata, buon equilibrio)</span>
                </button>
                <button data-quality="high" class="pdf-quality-btn w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    Alta <span class="block text-xs font-normal">(Lenta, file grande)</span>
                </button>
            </div>
            <button type="button" id="pdf-quality-cancel-btn" class="w-full mt-6 px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Annulla</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-10 relative">
                 <div class="absolute top-0 right-0 no-print">
                    <button id="admin-login-btn" class="user-only px-4 py-2 bg-gray-700 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-gray-800 transition-colors">Login Admin</button>
                    <button id="admin-logout-btn" class="admin-only px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors">Logout</button>
                </div>
                
                <div id="main-title-container" class="mt-8 max-w-3xl mx-auto"></div>
                 <h2 id="editor-subtitle" class="text-xl text-indigo-600 font-semibold mt-2 hidden">
                    Editor Itinerario
                </h2>

                <div class="mt-6 max-w-4xl mx-auto relative">
                    <img id="main-image-preview" class="w-full h-64 object-cover rounded-lg shadow-lg" src="" alt="Immagine di copertina">
                    <div id="main-image-placeholder" class="w-full h-64 bg-slate-200 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-400 hidden">
                        <div class="text-center text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6v12"></path></svg>
                            <p class="text-lg font-semibold mb-3">Immagine di copertina</p>
                            <div class="admin-only-flex justify-center gap-4">
                                <label for="main-image-input" class="px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">Carica File</label>
                                <button class="github-open-btn px-4 py-2 bg-gray-800 text-white rounded-lg shadow-sm hover:bg-gray-900" data-target-id="main">da GitHub</button>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="main-image-input" class="hidden" accept="image/*">
                </div>
            </header>
            
            <!-- Controls -->
            <div class="flex flex-wrap justify-center items-center gap-4 mb-8 no-print">
                <button id="save-btn" class="admin-only px-6 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors">Salva Modifiche</button>
                <span id="save-status" class="admin-only px-6 py-2 bg-green-100 border border-green-300 rounded-lg opacity-0">Salvato!</span>
                <button id="pdf-btn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">Salva come PDF</button>
                <button id="export-html-btn" class="admin-only px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition-colors">Esporta HTML</button>
                <button id="reset-btn" class="admin-only px-6 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors">Reset Itinerario</button>
            </div>

            <!-- Calendar -->
            <section id="calendar-summary" class="mb-10">
                <h2 class="text-2xl mb-4 border-b pb-2 border-gray-300 font-bold text-gray-700">Calendario del Viaggio</h2>
                <div id="calendar-container" class="flex flex-wrap justify-center gap-8"></div>
            </section>

            <!-- Tabs -->
            <div class="flex justify-center gap-4 mb-8 no-print">
                <button id="tab-btn-itinerary" class="tab-button active">Itinerario Dettagliato</button>
                <button id="tab-btn-flights" class="tab-button">Riepilogo Voli</button>
            </div>

            <!-- Tab Content -->
            <main id="main-content">
                <section id="itinerary-content">
                    <div id="itinerary-container"></div>
                </section>
                <section id="flights-content" class="hidden">
                    <div id="flights-container"></div>
                </section>
            </main>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const SITE_PASSWORD = 'Filippine2026';
        const ADMIN_PASSWORD = 'Kerrickleo';
        const PDF_QUALITY_PRESETS = {
            low:    { scale: 1.5, jpegQuality: 0.6, text: 'Bassa' },
            medium: { scale: 2,   jpegQuality: 0.7, text: 'Media' },
            high:   { scale: 3,   jpegQuality: 0.8, text: 'Alta' }
        };

        // --- GLOBAL VARIABLES ---
        let isAdminMode = false;
        let saveTimeout;
        let currentData = null;
        let currentImageTargetId = null;
        let isFirebaseMode = false; // Determined at runtime

        // --- DEFAULT DATA ---
        const defaultFullData = /*!JSON_DATA_PLACEHOLDER*/{
          "main": {
            "title": "Viaggio a Hong Kong, Macao e Filippine",
            "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20170955.png"
          },
          "flights": [
            { "idPrefix": "out", "title": "Volo di Andata: Bologna → Hong Kong", "depAirport": "Aeroporto di Bologna (BLQ)", "arrAirport": "Aeroporto Internazionale di Hong Kong (HKG)", "depTime": "2026-02-28T10:55", "arrTime": "2026-03-01T08:20", "depTz": "CET", "arrTz": "GMT+8" },
            { "idPrefix": "int1", "title": "Volo: Hong Kong → Boracay", "depAirport": "Aeroporto di Hong Kong (HKG)", "arrAirport": "Aeroporto di Caticlan (MPH)", "depTime": "2026-03-04T10:05", "arrTime": "2026-03-04T15:45", "depTz": "GMT+8", "arrTz": "GMT+8" },
            { "idPrefix": "int2", "title": "Volo: Boracay → El Nido", "depAirport": "Aeroporto di Caticlan (MPH)", "arrAirport": "Aeroporto di El Nido (ENI)", "depTime": "2026-03-10T15:15", "arrTime": "2026-03-10T16:25", "depTz": "GMT+8", "arrTz": "GMT+8" },
            { "idPrefix": "ret", "title": "Volo di Ritorno: Busuanga → Bologna", "depAirport": "Aeroporto di Busuanga (USU)", "arrAirport": "Aeroporto di Bologna (BLQ)", "depTime": "2026-03-21T16:15", "arrTime": "2026-03-22T09:55", "depTz": "GMT+8", "arrTz": "CET" }
          ],
          "itinerary": [
             { "date": "2026-03-01", "location": "Hong Kong", "isFlight": true, "isCruise": false, "accommodation": "Hotel a Tsim Sha Tsui", "activities": "Arrivo a Hong Kong, sistemazione in hotel e prima esplorazione del quartiere di Tsim Sha Tsui.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20173425.png" },
             { "date": "2026-03-02", "location": "Hong Kong", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Hong Kong", "activities": "Visita dell'Isola di Hong Kong: Victoria Peak, Aberdeen e Repulse Bay. Sera a Lan Kwai Fong.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20173622.png" },
             { "date": "2026-03-03", "location": "Macao / HK", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Hong Kong", "activities": "Escursione in giornata a Macao con il traghetto veloce. Visita del centro storico (Patrimonio UNESCO) e dei casinò.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20181139.png" },
             { "date": "2026-03-04", "location": "Boracay", "isFlight": true, "isCruise": false, "accommodation": "Volo per Boracay", "activities": "Mattinata libera. Trasferimento in aeroporto e volo per Caticlan (Boracay). Sistemazione in hotel.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20191330.png" },
             { "date": "2026-03-05", "location": "Boracay", "isFlight": false, "isCruise": false, "accommodation": "Hotel a Boracay", "activities": "Relax sulla White Beach, considerata una delle spiagge più belle del mondo. Tramonto al D'Mall.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20191719.png" },
             { "date": "2026-03-06", "location": "Boracay", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Boracay", "activities": "Attività acquatiche: snorkeling, paddleboarding o un'escursione in barca a vela (paraw).", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20191730.png" },
             { "date": "2026-03-07", "location": "Boracay", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Boracay", "activities": "Island hopping tour: visita a Puka Beach, Coral Garden e altre isole vicine.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20192746.png" },
             { "date": "2026-03-08", "location": "Boracay", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Boracay", "activities": "Relax o escursione al Monte Luho per una vista panoramica dell'isola.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20192857.png" },
             { "date": "2026-03-09", "location": "Boracay", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Boracay", "activities": "Giorno libero per shopping, massaggi sulla spiaggia o relax.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193211.png" },
             { "date": "2026-03-10", "location": "El Nido", "isFlight": true, "isCruise": false, "accommodation": "Volo per El Nido", "activities": "Partenza per El Nido (Palawan). Trasferimento in aeroporto e volo. Sistemazione in hotel.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193324.png" },
             { "date": "2026-03-11", "location": "El Nido", "isFlight": false, "isCruise": false, "accommodation": "Hotel a El Nido", "activities": "Escursione Tour A: Big Lagoon, Small Lagoon, Secret Lagoon, Shimizu Island, 7 Commando Beach.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193335.png" },
             { "date": "2026-03-12", "location": "El Nido", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a El Nido", "activities": "Escursione Tour C: Helicopter Island, Matinloc Shrine, Secret Beach, Star Beach, Hidden Beach.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193437.png" },
             { "date": "2026-03-13", "location": "El Nido", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a El Nido", "activities": "Giorno libero. Noleggio kayak per esplorare le spiagge vicine o relax a Las Cabañas Beach.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193713.png" },
             { "date": "2026-03-14", "location": "In Crociera", "isFlight": false, "isCruise": true, "accommodation": "A bordo della crociera", "activities": "Imbarco per la crociera di 3 giorni da El Nido a Coron. Prima giornata di navigazione e snorkeling.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193830.png" },
             { "date": "2026-03-15", "location": "In Crociera", "isFlight": false, "isCruise": true, "accommodation": "A bordo della crociera", "activities": "Esplorazione di isole remote, spiagge deserte e punti di snorkeling unici tra El Nido e Coron.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193856.png" },
             { "date": "2026-03-16", "location": "In Crociera", "isFlight": false, "isCruise": true, "accommodation": "A bordo della crociera", "activities": "Ultimo giorno di crociera. Visita di lagune e laghi spettacolari avvicinandosi a Coron.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20194101.png" },
             { "date": "2026-03-17", "location": "Coron", "isFlight": false, "isCruise": false, "accommodation": "Hotel a Coron", "activities": "Sbarco a Coron. Sistemazione in hotel e visita della cittadina. Salita al Mt. Tapyas per il tramonto.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20193713.png" },
             { "date": "2026-03-18", "location": "Coron", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Coron", "activities": "Tour di Coron Island: Kayangan Lake, Twin Lagoon, Siete Pecados Marine Park.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20194137.png" },
             { "date": "2026-03-19", "location": "Coron", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Coron", "activities": "Tour dei relitti giapponesi della Seconda Guerra Mondiale per gli appassionati di immersioni e snorkeling.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20194201.png" },
             { "date": "2026-03-20", "location": "Coron", "isFlight": false, "isCruise": false, "accommodation": "Stesso hotel a Coron", "activities": "Giorno libero a Coron. Relax alle Maquinit Hot Springs o visita al Calauit Safari Park.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20194331.png" },
             { "date": "2026-03-21", "location": "In Volo", "isFlight": true, "isCruise": false, "accommodation": "A bordo del volo", "activities": "Mattinata libera per gli ultimi acquisti. Trasferimento in aeroporto (Busuanga, USU) e partenza per l'Italia.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20195118.png" },
             { "date": "2026-03-22", "location": "Italia", "isFlight": false, "isCruise": false, "accommodation": "Casa", "activities": "Arrivo in Italia.", "image": "https://raw.githubusercontent.com/rigelpd/mio-itinerario/main/Screenshot%202025-08-02%20195203.png" }
          ]
        }/*!JSON_DATA_PLACEHOLDER*/;

        // --- DATA HANDLING ---
        function buildDataObjectFromDOM() {
            const data = {
                main: {
                    title: document.getElementById('main-title-input')?.value || document.querySelector('#main-title-container h1').textContent,
                    image: document.getElementById('main-image-preview').src,
                },
                flights: [],
                itinerary: [],
            };
            document.querySelectorAll('#flights-container .flight-card').forEach(card => {
                const idPrefix = card.dataset.idprefix;
                data.flights.push({
                    idPrefix: idPrefix,
                    title: card.querySelector('input[type="text"]')?.value,
                    depAirport: document.getElementById(`${idPrefix}-dep-airport`)?.value,
                    arrAirport: document.getElementById(`${idPrefix}-arr-airport`)?.value,
                    depTime: document.getElementById(`${idPrefix}-dep-time`)?.value,
                    arrTime: document.getElementById(`${idPrefix}-arr-time`)?.value,
                    depTz: document.getElementById(`${idPrefix}-dep-tz`)?.value,
                    arrTz: document.getElementById(`${idPrefix}-arr-tz`)?.value,
                });
            });
            document.querySelectorAll('#itinerary-container .day-card-wrapper').forEach((card, index) => {
                const dayId = `day${index + 1}`;
                data.itinerary.push({
                    date: document.getElementById(`${dayId}-date`)?.value,
                    location: document.getElementById(`${dayId}-location`)?.value,
                    isFlight: document.getElementById(`${dayId}-flight-check`)?.checked,
                    isCruise: document.getElementById(`${dayId}-cruise-check`)?.checked,
                    accommodation: document.getElementById(`${dayId}-accommodation`)?.value,
                    activities: document.getElementById(`${dayId}-activities`)?.value,
                    image: document.getElementById(`${dayId}-image-preview`)?.src,
                });
            });
            return data;
        }

        function saveItineraryToLocal() {
            if (!isAdminMode || isFirebaseMode) return;
            
            try {
                const dataToSave = buildDataObjectFromDOM();
                localStorage.setItem('travelItineraryData', JSON.stringify(dataToSave));
                
                // FIX: Update calendar on data change
                updateCalendar(dataToSave.itinerary); 

                const status = document.getElementById('save-status');
                status.textContent = 'Modifiche salvate!';
                status.classList.remove('hidden', 'opacity-0');

                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => status.classList.add('opacity-0'), 2000);
            } catch (e) { 
                console.error("Error saving to localStorage", e); 
            }
        }

        function loadItineraryFromLocal() {
            const savedData = localStorage.getItem('travelItineraryData');
            if (savedData) {
                try {
                    return JSON.parse(savedData);
                } catch(e) {
                    console.error("Could not parse local data, using default.", e);
                    return defaultFullData;
                }
            }
            return defaultFullData;
        }

        function resetData() {
            if(window.confirm("Sei sicuro di voler resettare l'itinerario alla versione di default? L'operazione è irreversibile.")) {
                localStorage.removeItem('travelItineraryData');
                currentData = defaultFullData;
                renderApp(currentData, isAdminMode);
            }
        }

        function exportHTML() {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) {
                console.error("Export failed: app-container not found.");
                return;
            }

            // 1. Get the latest data from the DOM
            const latestData = buildDataObjectFromDOM();
            const newDataString = JSON.stringify(latestData, null, 2);

            // 2. Temporarily hide the app container to reset to initial state for export
            const wasHidden = appContainer.classList.contains('hidden');
            if (!wasHidden) {
                appContainer.classList.add('hidden');
            }

            // 3. Get the HTML
            let currentHtml = document.documentElement.outerHTML;

            // 4. Immediately restore the view for the user
            if (!wasHidden) {
                appContainer.classList.remove('hidden');
            }

            // 5. Inject the new data into the clean HTML string
            const placeholderRegex = /\/\*!JSON_DATA_PLACEHOLDER\*\/[\s\S]*?\/\*!JSON_DATA_PLACEHOLDER\*\//;
            const newHtml = currentHtml.replace(placeholderRegex, `/*!JSON_DATA_PLACEHOLDER*/${newDataString}/*!JSON_DATA_PLACEHOLDER*/`);

            // 6. Create and trigger the download
            const blob = new Blob([newHtml], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- PDF EXPORT FUNCTION ---
        async function saveAsPDF(quality = PDF_QUALITY_PRESETS.medium) {
            const pdfBtn = document.getElementById('pdf-btn');
            pdfBtn.textContent = `Generazione PDF (${quality.text})...`;
            pdfBtn.disabled = true;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pdfWidth - (margin * 2);
            let y = margin;

            const addElementToPdf = async (element) => {
                const canvas = await html2canvas(element, {
                    scale: quality.scale,
                    useCORS: true,
                    logging: false,
                    width: element.offsetWidth,
                    windowWidth: element.offsetWidth
                });

                const imgData = canvas.toDataURL('image/jpeg', quality.jpegQuality);
                const imgHeight = (canvas.height * contentWidth) / canvas.width;

                if (y + imgHeight > pdfHeight - margin) {
                    pdf.addPage();
                    y = margin;
                }
                pdf.addImage(imgData, 'JPEG', margin, y, contentWidth, imgHeight);
                y += imgHeight + 5; // Spazio tra elementi
            };
            
            const printContainer = document.createElement('div');
            printContainer.style.position = 'absolute';
            printContainer.style.left = '-9999px';
            printContainer.style.width = '1024px';
            printContainer.style.backgroundColor = 'white';
            document.body.appendChild(printContainer);

            try {
                const prepareElementForPrint = (originalElement) => {
                    const clone = originalElement.cloneNode(true);
                    clone.style.padding = '10px';
                    clone.style.marginBottom = '0';
                    clone.classList.remove('hidden');
                    
                    clone.querySelectorAll('.no-print, button, input[type="file"], .github-open-btn, label[for*="-image-input"]').forEach(el => el.remove());
                    
                    clone.querySelectorAll('input, textarea').forEach(el => {
                        const p = document.createElement('div');
                        let value = el.value;
                        if (el.type === 'date') value = new Date(value + 'T00:00:00').toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
                        if (el.type === 'datetime-local') value = new Date(value).toLocaleString('it-IT', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        p.innerHTML = value.replace(/\n/g, '<br>');
                        p.className = 'readonly-text !p-0 !border-0 !bg-transparent';
                        el.parentNode.replaceChild(p, el);
                    });

                    clone.querySelectorAll('img[id$="-preview"]').forEach(img => {
                         if (img.src && (img.src.startsWith('data:') || img.src.startsWith('http'))) {
                            img.style.display = 'block';
                            img.classList.remove('hidden');
                        } else {
                            img.remove();
                        }
                    });
                    clone.querySelectorAll('.image-placeholder').forEach(el => el.remove());
                    
                    clone.querySelectorAll('.card').forEach(c => { c.style.boxShadow = 'none'; c.style.border = '1px solid #e5e7eb'; c.style.transform = 'none'; });

                    printContainer.appendChild(clone);
                    return clone;
                };

                // 1. Header
                const headerClone = prepareElementForPrint(document.querySelector('header'));
                await addElementToPdf(headerClone);
                printContainer.innerHTML = '';

                // 2. Calendar
                const calendarClone = prepareElementForPrint(document.getElementById('calendar-summary'));
                await addElementToPdf(calendarClone);
                printContainer.innerHTML = '';
                
                // 3. Itinerary Days
                pdf.addPage();
                y = margin;
                const itineraryTitle = document.createElement('h2');
                itineraryTitle.className = 'text-2xl mb-4 border-b pb-2 font-bold text-gray-700';
                itineraryTitle.textContent = 'Itinerario Dettagliato';
                printContainer.appendChild(itineraryTitle);
                await addElementToPdf(itineraryTitle);
                printContainer.innerHTML = '';

                const dayCards = document.querySelectorAll('#itinerary-container .day-card-wrapper');
                for (const card of dayCards) {
                    const cardClone = prepareElementForPrint(card);
                    await addElementToPdf(cardClone);
                    printContainer.innerHTML = '';
                }

                // 4. Flights Summary
                const flightsSection = document.getElementById('flights-content');
                if (flightsSection.querySelector('.flight-card')) {
                    pdf.addPage();
                    y = margin;
                    const flightsTitle = document.createElement('h2');
                    flightsTitle.className = 'text-2xl mb-4 border-b pb-2 font-bold text-gray-700';
                    flightsTitle.textContent = 'Riepilogo Voli';
                    printContainer.appendChild(flightsTitle);
                    await addElementToPdf(flightsTitle);
                    printContainer.innerHTML = '';

                    const flightCards = flightsSection.querySelectorAll('.flight-card');
                    for (const card of flightCards) {
                        const cardClone = prepareElementForPrint(card);
                        await addElementToPdf(cardClone);
                        printContainer.innerHTML = '';
                    }
                }
                
                const titleEl = isAdminMode ? document.getElementById('main-title-input') : document.querySelector('#main-title-container h1');
                const title = titleEl.value || titleEl.textContent;
                pdf.save(`itinerario_${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);

            } catch (error) {
                console.error("Errore durante la generazione del PDF:", error);
                alert("Si è verificato un errore durante la generazione del PDF. Controlla la console per i dettagli.");
            } finally {
                document.body.removeChild(printContainer);
                pdfBtn.textContent = 'Salva come PDF';
                pdfBtn.disabled = false;
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderApp(data, adminMode) {
            isAdminMode = adminMode;
            document.body.classList.toggle('admin-mode', adminMode);
            
            const mainTitleContainer = document.getElementById('main-title-container');
            const editorSubtitle = document.getElementById('editor-subtitle');

            if (adminMode) {
                mainTitleContainer.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold text-gray-800"><input type="text" id="main-title-input" value="${data.main.title}" class="w-full text-center border-0 focus:ring-0 bg-transparent p-0 m-0 font-bold text-3xl md:text-4xl"></h1>`;
                editorSubtitle.classList.remove('hidden');
            } else {
                mainTitleContainer.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold text-gray-800">${data.main.title}</h1>`;
                editorSubtitle.classList.add('hidden');
            }

            const mainImgPreview = document.getElementById('main-image-preview');
            const mainImgPlaceholder = document.getElementById('main-image-placeholder');
            const hasMainImage = data.main.image && (data.main.image.startsWith('data:image') || data.main.image.startsWith('http'));
            mainImgPreview.src = hasMainImage ? data.main.image : '';
            mainImgPreview.style.display = hasMainImage ? 'block' : 'none';
            mainImgPlaceholder.style.display = hasMainImage ? 'none' : 'flex';

            createDetailedItinerary(data.itinerary, adminMode);
            createFlightsList(data.flights, adminMode);
            updateCalendar(data.itinerary);
            setupDynamicEventListeners();
        }

        function updateCalendar(itineraryData) {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            if (!itineraryData || itineraryData.length === 0) return;
            
            itineraryData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const tripEvents = new Map();
            itineraryData.forEach(item => {
                let icons = '';
                if (item.isFlight) icons += '✈️';
                if (item.isCruise) icons += '🚢';
                if (icons) tripEvents.set(item.date, icons);
            });
            const tripDates = new Set(itineraryData.map(item => item.date));

            const firstDate = new Date(itineraryData[0].date + 'T12:00:00Z');
            const lastDate = new Date(itineraryData[itineraryData.length - 1].date + 'T12:00:00Z');

            let currentDate = new Date(Date.UTC(firstDate.getUTCFullYear(), firstDate.getUTCMonth(), 1));

            while (currentDate.getUTCFullYear() < lastDate.getUTCFullYear() || 
                  (currentDate.getUTCFullYear() === lastDate.getUTCFullYear() && currentDate.getUTCMonth() <= lastDate.getUTCMonth())) {
                
                const year = currentDate.getUTCFullYear();
                const month = currentDate.getUTCMonth();

                const monthContainer = document.createElement('div');
                monthContainer.className = 'w-full md:w-auto';

                const monthTitle = document.createElement('h3');
                monthTitle.className = 'text-xl font-semibold text-center mb-2 text-indigo-700';
                monthTitle.textContent = new Date(year, month).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                monthContainer.appendChild(monthTitle);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-7 gap-1 text-center text-sm';
                monthContainer.appendChild(grid);

                ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'].forEach(day => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.className = 'font-bold text-gray-500';
                    dayNameEl.textContent = day;
                    grid.appendChild(dayNameEl);
                });

                const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7;
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    grid.insertAdjacentHTML('beforeend', '<div></div>');
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = day;
                    dayEl.appendChild(dayNumber);

                    const thisDate = new Date(Date.UTC(year, month, day));
                    const dateString = thisDate.toISOString().split('T')[0];

                    if (tripDates.has(dateString)) {
                        dayEl.classList.add('trip-day');
                        dayEl.dataset.date = dateString;
                        if(tripEvents.has(dateString)) {
                            const iconsEl = document.createElement('div');
                            iconsEl.className = 'calendar-icons';
                            iconsEl.textContent = tripEvents.get(dateString);
                            dayEl.appendChild(iconsEl);
                        }
                    }
                    
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    if (thisDate.getTime() === today.getTime()) {
                         dayEl.classList.add('today');
                    }

                    grid.appendChild(dayEl);
                }
                
                container.appendChild(monthContainer);
                currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);
            }
        }

        function createDetailedItinerary(data, adminMode) {
            const container = document.getElementById('itinerary-container');
            const mapIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>`;

            container.innerHTML = data.map((item, index) => {
                const dayId = `day${index + 1}`;
                const dateObj = new Date(item.date + 'T12:00:00Z');
                const dateString = dateObj.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                const hasImage = item.image && (item.image.startsWith('data:') || item.image.startsWith('http'));

                const editableFields = `
                    <div><label for="${dayId}-date">Data</label><input type="date" id="${dayId}-date" value="${item.date}"></div>
                    <div><label for="${dayId}-location">Località</label><input type="text" id="${dayId}-location" value="${item.location}"></div>
                    <div>
                        <label for="${dayId}-accommodation">Alloggio</label>
                        <div class="relative flex items-center">
                            <input type="text" id="${dayId}-accommodation" value="${item.accommodation}" class="pr-10">
                            <a href="#" class="gmaps-link absolute right-0 top-0 h-full flex items-center px-3 text-gray-400 hover:text-indigo-600" data-input-id="${dayId}-accommodation" title="Apri in Google Maps">
                                ${mapIconSvg}
                            </a>
                        </div>
                    </div>
                    <div class="flex-grow flex flex-col"><label for="${dayId}-activities">Attività</label><textarea id="${dayId}-activities" class="w-full">${item.activities}</textarea></div>
                    <div class="flex items-center gap-6 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="${dayId}-flight-check" ${item.isFlight ? 'checked' : ''} class="w-5 h-5 rounded text-indigo-600 focus:ring-indigo-500"> <span>✈️ Volo</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="${dayId}-cruise-check" ${item.isCruise ? 'checked' : ''} class="w-5 h-5 rounded text-sky-600 focus:ring-sky-500"> <span>🚢 Crociera</span></label>
                    </div>`;

                const readonlyFields = `
                    <div><label>Località</label><div class="readonly-text">${item.location}</div></div>
                    <div>
                        <label>Alloggio</label>
                        <div class="flex items-center justify-between readonly-text">
                            <span class="flex-grow">${item.accommodation}</span>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.accommodation)}" target="_blank" title="Apri in Google Maps" class="p-1 text-gray-400 hover:text-indigo-600">
                                ${mapIconSvg}
                            </a>
                        </div>
                    </div>
                    <div class="flex-grow flex flex-col"><label>Attività</label><div class="readonly-text">${item.activities.replace(/\n/g, '<br>')}</div></div>`;

                return `
                    <div class="card day-card flex flex-col md:flex-row gap-6 items-stretch day-card-wrapper" data-date="${item.date}">
                        <div class="w-full md:w-1/2 flex flex-col">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">${dateString} (Giorno ${index + 1})</h3>
                            <div class="grid grid-cols-1 gap-4 flex-grow">
                                ${adminMode ? editableFields : readonlyFields}
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 relative">
                            <img id="${dayId}-image-preview" class="object-cover w-full h-full rounded-lg" style="display: ${hasImage ? 'block' : 'none'}" src="${hasImage ? item.image : ''}" alt="Anteprima"/>
                            <div id="${dayId}-image-placeholder" class="image-placeholder w-full h-full bg-slate-200 rounded-lg items-center justify-center border-2 border-dashed border-gray-400" style="display: ${hasImage ? 'none' : 'flex'}">
                                 <div class="text-center text-gray-600">
                                    <div class="admin-only-flex justify-center gap-4">
                                        <label for="${dayId}-image-input" class="px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 text-sm">Carica File</label>
                                        <button class="github-open-btn px-4 py-2 bg-gray-800 text-white rounded-lg shadow-sm hover:bg-gray-900 text-sm" data-target-id="${dayId}">da GitHub</button>
                                    </div>
                                    <p class="user-only font-semibold">Nessuna immagine</p>
                                </div>
                            </div>
                            <input type="file" id="${dayId}-image-input" class="hidden" accept="image/*">
                        </div>
                    </div>`;
            }).join('');
        }
        function createFlightsList(data, adminMode) {
            const container = document.getElementById('flights-container');
            const mapIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>`;

            const createAirportField = (label, id, value, isReadonly) => {
                const gmapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(value)}`;
                if (isReadonly) {
                    return `<div><label>${label}</label><div class="flex items-center justify-between readonly-text"><span>${value}</span><a href="${gmapsLink}" target="_blank" class="p-1 text-gray-400 hover:text-indigo-600">${mapIconSvg}</a></div></div>`;
                }
                return `<div><label for="${id}">${label}</label><div class="relative flex items-center"><input type="text" id="${id}" value="${value}" class="pr-10"><a href="#" class="gmaps-link absolute right-0 top-0 h-full flex items-center px-3 text-gray-400 hover:text-indigo-600" data-input-id="${id}">${mapIconSvg}</a></div></div>`;
            };

            container.innerHTML = data.map(flight => {
                const depTime = new Date(flight.depTime).toLocaleString('it-IT', { dateStyle: 'short', timeStyle: 'short' });
                const arrTime = new Date(flight.arrTime).toLocaleString('it-IT', { dateStyle: 'short', timeStyle: 'short' });

                const editableFields = `
                    <h3 class="text-xl mb-4 font-semibold text-indigo-700">✈️ <input type="text" value="${flight.title}" class="inline-block w-auto !p-1 bg-transparent border-0 border-b focus:ring-0"></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${createAirportField('Aeroporto Partenza', `${flight.idPrefix}-dep-airport`, flight.depAirport, false)}
                        ${createAirportField('Aeroporto Arrivo', `${flight.idPrefix}-arr-airport`, flight.arrAirport, false)}
                        <div><label for="${flight.idPrefix}-dep-time">Data/Ora Partenza</label><input type="datetime-local" id="${flight.idPrefix}-dep-time" value="${flight.depTime}"></div>
                        <div><label for="${flight.idPrefix}-arr-time">Data/Ora Arrivo</label><input type="datetime-local" id="${flight.idPrefix}-arr-time" value="${flight.arrTime}"></div>
                        <div><label for="${flight.idPrefix}-dep-tz">Fuso Orario Partenza</label><input type="text" id="${flight.idPrefix}-dep-tz" value="${flight.depTz}"></div>
                        <div><label for="${flight.idPrefix}-arr-tz">Fuso Orario Arrivo</label><input type="text" id="${flight.idPrefix}-arr-tz" value="${flight.arrTz}"></div>
                    </div>`;
                
                const readonlyFields = `
                    <h3 class="text-xl mb-4 font-semibold text-indigo-700">✈️ ${flight.title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${createAirportField('Aeroporto Partenza', `${flight.idPrefix}-dep-airport`, flight.depAirport, true)}
                        ${createAirportField('Aeroporto Arrivo', `${flight.idPrefix}-arr-airport`, flight.arrAirport, true)}
                        <div><label>Data/Ora Partenza</label><div class="readonly-text">${depTime}</div></div>
                        <div><label>Data/Ora Arrivo</label><div class="readonly-text">${arrTime}</div></div>
                        <div><label>Fuso Orario Partenza</label><div class="readonly-text">${flight.depTz}</div></div>
                        <div><label>Fuso Orario Arrivo</label><div class="readonly-text">${flight.arrTz}</div></div>
                    </div>`;

                return `
                    <div class="card flight-card" data-idprefix="${flight.idPrefix}">
                        ${adminMode ? editableFields : readonlyFields}
                        <p id="${flight.idPrefix}-duration" class="mt-4 text-lg font-semibold text-indigo-800"></p>
                    </div>`;
            }).join('');

            data.forEach(flight => calculateDuration(
                `${flight.idPrefix}-dep-time`, `${flight.idPrefix}-arr-time`, 
                `${flight.idPrefix}-dep-tz`, `${flight.idPrefix}-arr-tz`, 
                `${flight.idPrefix}-duration`
            ));
        }

        // --- UTILITY & EVENT LISTENERS ---
        function handleGmapsLinkClick(e) {
            e.preventDefault();
            const link = e.currentTarget;
            const inputId = link.dataset.inputId;
            if (inputId) {
                const input = document.getElementById(inputId);
                if (input && input.value) {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(input.value)}`, '_blank');
                }
            }
        }
        function getTimezoneOffset(tzString) { tzString = tzString.toUpperCase(); if (tzString === 'CET') return 1; if (tzString.startsWith('GMT+')) return parseInt(tzString.replace('GMT+', ''), 10); if (tzString.startsWith('GMT-')) return -parseInt(tzString.replace('GMT-', ''), 10); return 0; }
        function formatOffset(offset) { const sign = offset >= 0 ? '+' : '-'; const absOffset = Math.abs(offset); const hours = String(Math.floor(absOffset)).padStart(2, '0'); const minutes = String((absOffset % 1) * 60).padStart(2, '0'); return `${sign}${hours}:${minutes}`; }
        function calculateDuration(depTimeId, arrTimeId, depTzId, arrTzId, durationElId) { const [depTimeInput, arrTimeInput, depTzInput, arrTzInput, durationEl] = [depTimeId, arrTimeId, depTzId, arrTzId, durationElId].map(id => document.getElementById(id)); if (!depTimeInput || !arrTimeInput || !depTzInput || !arrTzInput || !durationEl) return; if (depTimeInput.value && arrTimeInput.value && depTzInput.value && arrTzInput.value) { try { const depOffset = getTimezoneOffset(depTzInput.value); const arrOffset = getTimezoneOffset(arrTzInput.value); const depDate = new Date(`${depTimeInput.value}:00${formatOffset(depOffset)}`); const arrDate = new Date(`${arrTimeInput.value}:00${formatOffset(arrOffset)}`); let diff = arrDate.getTime() - depDate.getTime(); if (diff < 0) { durationEl.textContent = "Arrivo prima della partenza."; durationEl.classList.add('text-red-500'); return; } durationEl.classList.remove('text-red-500'); const diffHours = Math.floor(diff / 3600000); const diffMinutes = Math.round((diff % 3600000) / 60000); durationEl.textContent = `Durata: ${diffHours}h ${diffMinutes}m`; } catch(e) { durationEl.textContent = "Date non valide"; } } }
        function autoGrowTextarea(element) { if(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; } }
        async function compressImage(file, maxWidth = 1280, maxHeight = 1280, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }
        async function handleImageUpload(event) {
            const input = event.target;
            const idPrefix = input.id.replace('-image-input', '');
            const file = input.files[0];
            if (file) {
                try {
                    const compressedDataUrl = await compressImage(file);
                    applyImageChange(idPrefix, compressedDataUrl);
                } catch (error) { console.error("Error compressing image:", error); }
            }
        }
        function applyImageChange(targetId, imageUrl) {
            const preview = document.getElementById(`${targetId}-image-preview`);
            const placeholder = document.getElementById(`${targetId}-image-placeholder`);
            preview.src = imageUrl;
            preview.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';
        }
        function openGitHubModal(targetId) {
            currentImageTargetId = targetId;
            document.getElementById('github-modal').style.display = 'flex';
        }
        function closeGitHubModal() {
            document.getElementById('github-modal').style.display = 'none';
            document.getElementById('github-image-grid').innerHTML = '';
            document.getElementById('github-feedback').textContent = '';
            currentImageTargetId = null;
        }
        async function fetchGitHubImages() {
            const user = document.getElementById('github-user').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const grid = document.getElementById('github-image-grid');
            const feedback = document.getElementById('github-feedback');
            const fetchBtn = document.getElementById('fetch-github-images-btn');
            if (!user || !repo) {
                feedback.textContent = 'Per favore, inserisci nome utente e repository.';
                feedback.className = 'text-red-500 text-sm mb-2';
                return;
            }
            feedback.textContent = 'Caricamento immagini...';
            feedback.className = 'text-blue-500 text-sm mb-2';
            grid.innerHTML = '';
            fetchBtn.disabled = true;
            try {
                const response = await fetch(`https://api.github.com/repos/${user}/${repo}/contents`);
                if (!response.ok) throw new Error(`Errore: ${response.statusText}`);
                const data = await response.json();
                const imageFiles = data.filter(file => /\.(jpe?g|png|gif|webp)$/i.test(file.name));
                if (imageFiles.length === 0) {
                    feedback.textContent = 'Nessuna immagine trovata nel repository.';
                    feedback.className = 'text-yellow-500 text-sm mb-2';
                    return;
                }
                feedback.textContent = `Trovate ${imageFiles.length} immagini. Clicca per selezionare.`;
                feedback.className = 'text-green-600 text-sm mb-2';
                imageFiles.forEach(file => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'cursor-pointer border-2 border-transparent hover:border-indigo-500 rounded-lg overflow-hidden';
                    const img = document.createElement('img');
                    img.src = file.download_url;
                    img.alt = file.name;
                    img.className = 'w-full h-full object-cover';
                    imgContainer.appendChild(img);
                    imgContainer.addEventListener('click', () => {
                        applyImageChange(currentImageTargetId, file.download_url);
                        closeGitHubModal();
                    });
                    grid.appendChild(imgContainer);
                });
            } catch (error) {
                console.error('GitHub API error:', error);
                feedback.textContent = `Errore nel caricamento: ${error.message}`;
                feedback.className = 'text-red-500 text-sm mb-2';
            } finally {
                fetchBtn.disabled = false;
            }
        }
        function setupStaticEventListeners() {
            document.getElementById('reset-btn').addEventListener('click', resetData);
            document.getElementById('pdf-btn').addEventListener('click', () => {
                document.getElementById('pdf-quality-modal').classList.remove('hidden');
            });
            document.getElementById('save-btn').addEventListener('click', saveItineraryToLocal);
            document.getElementById('export-html-btn').addEventListener('click', exportHTML);
            
            const itineraryBtn = document.getElementById('tab-btn-itinerary');
            const flightsBtn = document.getElementById('tab-btn-flights');
            itineraryBtn.addEventListener('click', () => { document.getElementById('itinerary-content').classList.remove('hidden'); document.getElementById('flights-content').classList.add('hidden'); itineraryBtn.classList.add('active'); flightsBtn.classList.remove('active'); });
            flightsBtn.addEventListener('click', () => { document.getElementById('itinerary-content').classList.add('hidden'); document.getElementById('flights-content').classList.remove('hidden'); itineraryBtn.classList.remove('active'); flightsBtn.classList.add('active'); });
            
            document.getElementById('fetch-github-images-btn').addEventListener('click', fetchGitHubImages);
            document.getElementById('close-github-modal-btn').addEventListener('click', closeGitHubModal);

            document.getElementById('pdf-quality-cancel-btn').addEventListener('click', () => {
                document.getElementById('pdf-quality-modal').classList.add('hidden');
            });
            document.querySelectorAll('.pdf-quality-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const quality = btn.dataset.quality;
                    document.getElementById('pdf-quality-modal').classList.add('hidden');
                    saveAsPDF(PDF_QUALITY_PRESETS[quality]);
                });
            });

            document.getElementById('admin-login-btn').addEventListener('click', () => { document.getElementById('admin-login-modal').classList.remove('hidden'); document.getElementById('admin-password-input').focus(); });
            document.getElementById('admin-logout-btn').addEventListener('click', handleAdminLogout);
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            document.getElementById('admin-cancel-btn').addEventListener('click', () => { document.getElementById('admin-login-modal').classList.add('hidden'); });
        }
        function setupDynamicEventListeners() {
            const inputs = document.querySelectorAll('#main-content input, #main-content textarea, #main-title-container input');
            inputs.forEach(el => {
                el.removeEventListener('input', saveItineraryToLocal);
                el.addEventListener('input', saveItineraryToLocal);
            });
            const checkboxes = document.querySelectorAll('#main-content input[type="checkbox"]');
             checkboxes.forEach(el => {
                el.removeEventListener('change', saveItineraryToLocal);
                el.addEventListener('change', saveItineraryToLocal);
            });
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.removeEventListener('change', handleImageUpload);
                input.addEventListener('change', handleImageUpload);
            });
            document.querySelectorAll('textarea[id$="-activities"]').forEach(textarea => { autoGrowTextarea(textarea); textarea.addEventListener('input', () => autoGrowTextarea(textarea)); });
            
            document.body.removeEventListener('click', eventDelegationHandler);
            document.body.addEventListener('click', eventDelegationHandler);
        }
        function eventDelegationHandler(e) {
            if (e.target.closest('.github-open-btn')) {
                openGitHubModal(e.target.closest('.github-open-btn').dataset.targetId);
            }
            if(e.target.closest('.gmaps-link')) {
                handleGmapsLinkClick(e);
            }
            if(e.target.closest('.trip-day')) {
                const date = e.target.closest('.trip-day').dataset.date;
                if(date) {
                    const targetCard = document.querySelector(`.day-card-wrapper[data-date="${date}"]`);
                    if(targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }
        }
        
        // --- AUTH & INITIALIZATION LOGIC ---
        function handleSitePassword(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('site-password-input');
            const errorEl = document.getElementById('site-password-error');
            if (passwordInput.value === SITE_PASSWORD) {
                document.getElementById('site-password-modal').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeApp();
            } else {
                errorEl.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function handleAdminLogin(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('admin-password-input');
            const errorEl = document.getElementById('admin-password-error');
            if (passwordInput.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdmin', 'true');
                document.getElementById('admin-login-modal').classList.add('hidden');
                errorEl.classList.add('hidden');
                passwordInput.value = '';
                renderApp(currentData, true);
            } else {
                errorEl.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function handleAdminLogout() {
            sessionStorage.removeItem('isAdmin');
            renderApp(currentData, false);
        }
        
        function initializeApp() {
            // For now, we only support local storage mode.
            // Firebase logic can be re-added here if needed.
            isFirebaseMode = false;
            document.getElementById('editor-subtitle').textContent = 'Editor Itinerario';
            document.getElementById('save-btn').classList.remove('hidden');

            isAdminMode = sessionStorage.getItem('isAdmin') === 'true';
            currentData = loadItineraryFromLocal();
            renderApp(currentData, isAdminMode);
            setupStaticEventListeners();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('site-password-form').addEventListener('submit', handleSitePassword);
            document.getElementById('site-password-input').focus();
        });
    </script>
</body>
</html>
